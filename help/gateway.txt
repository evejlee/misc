Note if things don't work randomly, try reloading iptables
        sudo iptables-restore < /etc/iptables.rules
Especially do so after an OS update

On ubuntu:

- Install the new card.  

    You might have to reboot a couple of times before the cards get
    properly recognized. Below I assume the main card is eth0 and the
    one for internal network is eth1


- install dhcp3-server


- Set up your /etc/dhcp3/dhcpd.conf

    Note that there are BNL specific things here.

    the "range" gives the dhcp ip address range we will use. Note 51
    will be the first given.

    The 172.16.100.0 is our subnet.  Note we used
    this one because bnl takes up the "home" addresses
    typically used for this.

    the 172.16.100.1 will be the router.

    those are bnl name servers.

#
# DHCP Server Configuration file.
#   see /usr/share/doc/dhcp*/dhcpd.conf.sample  
#
ddns-update-style none;

subnet 172.16.100.0 netmask 255.255.255.0 {
   range 172.16.100.50 172.16.100.75;
   default-lease-time 86400;
   max-lease-time 604800;
   option subnet-mask 255.255.255.0;
   option broadcast-address 172.16.100.255;
   option routers 172.16.100.1;
   option domain-name-servers 130.199.1.1, 130.199.128.31;
   option domain-name "bnl.gov";
}


- set up iptables

    Use this for your /etc/iptables.rules.  How you load it at runtime is with
        iptables-restore < filename

    Note 130.199.20.202 is the address of the gateway machine at bnl. We
    again use the 172.16.100.0 here.

    NOTE: I had to rerun 
        sudo iptables-restore < /etc/iptables.rules
    when I updated ubuntu.


# Generated by iptables-save v1.4.4 on Fri Oct 29 18:42:06 2010
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A POSTROUTING -s 172.16.100.0/24 -o eth0 -j SNAT --to-source 130.199.20.202 
COMMIT
# Completed on Fri Oct 29 18:42:06 2010
# Generated by iptables-save v1.4.4 on Fri Oct 29 18:42:06 2010
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
#-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT 
#-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A FORWARD -i eth1 -j ACCEPT 
COMMIT
# Completed on Fri Oct 29 18:42:06 2010


Then you need to allow packet forwarding in the kernel.

Edit /etc/sysctl.conf and uncomment this
    net.ipv4.ip_forward=1

You can reload with
    sysctl -p

